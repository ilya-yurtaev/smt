var app=app||{};!function(){"use strict";function a(a){return $(a).get()[0]}function b(a){a.preventDefault(),a.stopPropagation()}var c=13,d=$.datepicker.regional.ru;d.dateFormat="yy-mm-dd",d.prevText="&larr;",d.nextText="&rarr;",d.onSelect=function(a,b){var c=b.input[0];if("button"==$(c).attr("type")){var d=app.get_current_collection().get($(c).attr("data-object-id")),e={};e[c.name]=$(c).val(),d.save(e),app.get_current_collection().fetch()}},app.datepicker_params=d;var e=React.createClass({displayName:"Cell",getInitialState:function(){return{old_value:void 0,value:void 0,changed:!1}},handleFocus:function(a){this.setState({old_value:a.target.value})},handleBlur:function(a){this.setState({editable:!1}),this.setState({value:a.target.value});var b=a.target,c=b.value,d=b.name;c&&c!=this.state.old_value&&(this.setState({changed:!0}),this.save(d,c))},handleKeyDown:function(a){switch(a.keyCode){case c:$(a.target).trigger("blur")}},handleClick:function(a){this.setState({editable:!0});var b=a.target;$(b).focus(),$(b).select()},save:function(a,b){this.setState({value:b});var c=app.get_current_collection().get(this.obj.id),d={};d[a]=b,c.save(d),app.get_current_collection().fetch()},render:function(){this.obj=this.props.obj,this.field=this.props.field.field;var a=this.state.value||this.obj[this.props.field.name],b="Press Enter to save, Escape to cancel",c=React.DOM.input({onClick:this.handleClick,type:this.state.editable?app.get_field_type(this.field.type):"button",name:this.props.field.name,defaultValue:a,title:b,onBlur:this.handleBlur,onFocus:this.handleFocus,onKeyDown:this.handleKeyDown,"data-object-id":this.obj.id,size:a.length,className:app.get_field_type(this.field.type)});return React.DOM.td(null,c)}}),f=React.createClass({displayName:"Table",mixins:[Backbone.React.Component.mixin],create_cells:function(a){var b=[];return _.each(this.fields,function(c){b.push(e({field:c,obj:a}))}),b},create_th:function(a){var a=a.field;return React.DOM.th({className:a.type,scope:"col"},a.verbose_name)},create_thead:function(){return React.DOM.tr(null,_.map(this.fields,this.create_th))},create_row:function(a){return React.DOM.tr({key:a.id,"data-url":a.resource_uri,"data-id":a.id},this.create_cells(a))},render:function(){var a=this.props.schema,b={},c=_.invert(a.fields_order);_.map(_.omit(a.fields,app.exclude_fields),function(a,d){b[c[d]]={name:d,field:a}});var d=this.props.collection.length,e=app.pluralize(d,a.plural_forms),f=[d,e].join(" "),h=_.keys(this.fields).length;return this.schema=a,this.fields=b,React.DOM.div(null,React.DOM.table({id:"data-table"},React.DOM.thead(null,this.create_thead()),React.DOM.tbody(null,this.props.collection.map(this.create_row)),React.DOM.tfoot(null,React.DOM.tr(null,React.DOM.td({colSpan:h},f)))),g({root_url:this.props.root_url,fields:this.fields}))}}),g=React.createClass({displayName:"Form",getInitialState:function(){return{visible:!1}},toggle_form:function(){this.setState({visible:!this.state.visible}),$("#modelform").toggle(300)},create_inputs:function(a){if("id"!=a.name&&"resource_uri"!=a.name){var b=a.name,a=a.field,c=a.blank?"":"required",d="id_"+b;return React.DOM.p(null,React.DOM.label({htmlFor:d},a.verbose_name),React.DOM.input({id:d,type:app.get_field_type(a.type),name:b,required:c,className:app.get_field_type(a.type)}))}},handleSubmit:function(a){b(a);var c=Backbone.Syphon.serialize(a.target),d=app.get_current_collection();d.create(c),$(a.target).trigger("reset")},render:function(){var a=["Добавить ",app.inflect("accs"),this.state.visible?"–":"+"].join(" ");return React.DOM.div(null,React.DOM.p(null,React.DOM.span({className:"link",onClick:this.toggle_form},a)),React.DOM.form({method:"post",id:"modelform",action:this.props.root_url,className:this.state.visible?"visible":"hidden",onSubmit:this.handleSubmit},React.DOM.fieldset(null,_.map(this.props.fields,this.create_inputs)),React.DOM.p({className:"submit"},React.DOM.input({type:"submit",value:"Добавить"}))))}}),h=React.createClass({displayName:"Menu",getInitialState:function(){return{path:app.build_url(app.current_collection)}},switchCollection:function(a){this.setState({path:a.target.href.split("#")[1]})},create_link:function(a,b){var c=app.build_url(b),d=~c.indexOf(this.state.path)?"active":"";return React.DOM.li(null,React.DOM.a({id:b,"data-model":b,onClick:this.switchCollection,className:d,href:c},a))},render:function(){return React.DOM.ul(null,_.map(this.props.links,this.create_link))}});app.render_templates=function(){app.render_menu(),app.render_table(app.get_current_collection())},app.render_menu=function(){React.renderComponent(h({links:app.routes}),a("#menu"))},app.render_table=function(b){var c=a("#data");c&&React.unmountComponentAtNode(c),React.renderComponent(f({collection:b,model:b.model,schema:b.schema,root_url:b.url}),c),$(document.body).on("focus",".datetime",function(){$(this).datepicker(app.datepicker_params)})}}();